<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сравнение моделей — Результаты</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container my-4">
  <h1 class="text-center mb-4">Результаты сравнения моделей</h1>

  <div id="no-data" class="alert alert-warning" style="display: none;">
    Нет результатов. Сначала заполните форму на главной странице.
    <a href="/" class="btn btn-sm btn-primary ms-2">Перейти на главную</a>
  </div>

  <div id="resultsBlock" style="display: none;">
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Топ моделей</h5>
        <ul id="topList" class="list-group"></ul>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">График сравнения (остаток ёмкости, %)</h5>
        <canvas id="barChart" height="120"></canvas>
      </div>
    </div>

    <div class="text-end">
      <a href="/" class="btn btn-secondary">Назад</a>
      <button id="clearBtn" class="btn btn-danger">Очистить результаты</button>
    </div>
  </div>
</div>

<script>
function render(predictions) {
  const names = Object.keys(predictions);
  const values = names.map(n => predictions[n]);

  // Топ (по убыванию)
  const sorted = Object.entries(predictions).sort((a,b) => b[1] - a[1]);

  const topList = document.getElementById("topList");
  topList.innerHTML = "";
  sorted.forEach(([name, val], idx) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `<strong>${idx+1}. ${name}</strong><span class="badge bg-primary">${val}%</span>`;
    topList.appendChild(li);
  });

  // График через Chart.js
  const ctx = document.getElementById('barChart').getContext('2d');
  // Если уже есть график — уничтожим чтобы перерисовать
  if (window._predChart) window._predChart.destroy();
  window._predChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: names,
      datasets: [{
        label: 'Остаток ёмкости (%)',
        data: values,
        backgroundColor: names.map((_, i) => 'rgba(54, 162, 235, 0.6)'),
        borderColor: names.map((_, i) => 'rgba(54, 162, 235, 1)'),
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, max: 100 }
      },
      plugins: { legend: { display: false } }
    }
  });
}

document.addEventListener("DOMContentLoaded", function() {
  const raw = sessionStorage.getItem("predictions");
  if (!raw) {
    document.getElementById("no-data").style.display = "block";
    return;
  }
  const preds = JSON.parse(raw);
  document.getElementById("resultsBlock").style.display = "block";
  render(preds);

  document.getElementById("clearBtn").addEventListener("click", function() {
    sessionStorage.removeItem("predictions");
    window.location.href = "/";
  });
});
</script>
</body>
</html>
